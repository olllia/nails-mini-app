<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Nails & Aesthetic</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* Подключаем стильный шрифт */
@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap');

:root {
  --primary: #1A1AA7;    /* Глубокий синий */
  --accent: #F295A0;     /* Пыльная роза */
  --bg-color: #f0f0f0;
  --glass: rgba(255, 255, 255, 0.85);
  --radius: 24px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
  margin: 0;
  font-family: 'Manrope', sans-serif;
  color: #272A2A;
  /* Твое изображение на фоне */
  background: url('https://pin.it/4BCPgMqUk') no-repeat center center fixed;
  background-size: cover;
  min-height: 100vh;
  line-height: 1.4;
}

#app { max-width: 420px; margin: 0 auto; padding: 20px; }

/* Хедер */
header { text-align: center; margin-bottom: 30px; padding-top: 10px; }
header h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: var(--primary); }
.master-link { 
  display: inline-block; margin-top: 8px; color: white; text-decoration: none; 
  font-size: 13px; background: var(--primary); padding: 6px 14px; border-radius: 20px; font-weight: 600;
}

/* Переключатель */
.tabs { display: flex; background: rgba(0,0,0,0.06); padding: 4px; border-radius: 16px; margin-bottom: 25px; }
.tabs button { 
  flex: 1; border: none; padding: 10px; border-radius: 12px; font-size: 14px; 
  font-weight: 600; cursor: pointer; background: transparent; color: #666; transition: 0.3s;
}
.tabs button.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

/* Карточки */
.glass-card {
  background: var(--glass);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.5);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}

.section-title { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin: 0 0 12px 5px; opacity: 0.8; }

/* Календарь */
.calendar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
.calendar::-webkit-scrollbar { display: none; }
.day { 
  min-width: 60px; padding: 15px 5px; border-radius: 20px; text-align: center; 
  background: var(--glass); border: 1.5px solid transparent; transition: 0.2s;
}
.day span { display: block; font-size: 10px; opacity: 0.6; margin-bottom: 4px; }
.day b { font-size: 18px; }
.day.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Слоты */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.slot { 
  padding: 14px; border-radius: 16px; text-align: center; 
  font-size: 14px; font-weight: 600; background: var(--glass); cursor: pointer; border: 1.5px solid transparent;
}
.slot.selected { border-color: var(--primary); background: white; color: var(--primary); }

/* Услуги */
.service-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
.service-item:last-child { border: none; }
.checkbox { width: 22px; height: 22px; border: 2.5px solid var(--primary); border-radius: 8px; transition: 0.2s; }
.service-item.active .checkbox { background: var(--primary); position: relative; }
.service-item.active .checkbox::after { content: '✓'; color: white; font-size: 14px; position: absolute; left: 3px; top: -2px; }

/* Поле ввода */
textarea { 
  width: 100%; border: none; border-radius: 16px; padding: 15px; 
  font-family: inherit; font-size: 14px; background: rgba(255,255,255,0.6); resize: none;
}

/* Кнопка */
.btn-primary { 
  width: 100%; background: var(--primary); color: white; border: none; border-radius: 20px; 
  padding: 20px; font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.2s;
  box-shadow: 0 10px 25px rgba(26, 26, 167, 0.25);
}
.btn-primary:active { transform: scale(0.96); }

/* Админка */
.admin-list-item { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 13px; }
.stat-box { display: flex; gap: 10px; margin-bottom: 20px; }
.stat-card { flex: 1; background: var(--primary); color: white; padding: 15px; border-radius: 20px; text-align: center; }
</style>
</head>
<body onclick="document.activeElement.blur()">

<div id="app">
  <header>
    <h1>Nails & Aesthetic</h1>
    <a href="https://t.me/nnstmlll" class="master-link">мастер: @nnstmlll</a>
  </header>

  <div class="tabs">
    <button id="clientBtn" class="active">Запись</button>
    <button id="adminBtn">Управление</button>
  </div>

  <div id="clientPanel">
    <div class="section-title">1. Выберите дату</div>
    <div class="calendar" id="calendar"></div>

    <div class="section-title" style="margin-top:25px;">2. Свободное время</div>
    <div id="slots" class="slots-grid">
      <div style="grid-column:1/4; font-size:14px; opacity:0.5; padding:20px; text-align:center;">Сначала выберите дату</div>
    </div>

    <div class="section-title" style="margin-top:25px;">3. Услуги</div>
    <div class="glass-card" id="servicesContainer"></div>

    <div class="section-title">4. Комментарий</div>
    <div class="glass-card" style="padding: 10px;">
      <textarea id="comment" rows="2" placeholder="Ваши пожелания..." onclick="event.stopPropagation()"></textarea>
    </div>

    <div style="text-align:center; margin: 30px 0;">
      <div style="font-size: 12px; opacity: 0.6; font-weight: 700; letter-spacing: 1px;">ИТОГО</div>
      <div style="font-size: 36px; font-weight: 800; color: var(--primary);"><span id="totalDisplay">0</span> ₽</div>
    </div>

    <button class="btn-primary" onclick="submitBooking()">Записаться ✨</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="stat-box">
        <div class="stat-card"><small>Выручка</small><br><b id="statRevenue">0 ₽</b></div>
        <div class="stat-card"><small>Ср. чек</small><br><b id="statAvg">0 ₽</b></div>
    </div>
    
    <div class="section-title">Добавить окошки</div>
    <div class="glass-card" style="background: #1a1a1a;">
      <textarea id="bulkInput" style="background:transparent; color:#00ff00; font-family:monospace;" rows="4" placeholder="15.01 10:00/12:00/14:00" onclick="event.stopPropagation()"></textarea>
      <button class="btn-primary" style="margin-top:15px; background:white; color:black;" onclick="handleBulkUpload()">Опубликовать</button>
    </div>

    <div class="section-title">Список записей</div>
    <div class="glass-card" id="adminAppointments" style="padding:0;"></div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// Настройки
const API = "https://nails-backend-5knq.onrender.com"; // ЗАМЕНИ НА СВОЙ
const ADMIN_ID = 381232429;
const userId = tg.initDataUnsafe?.user?.id || 381232429;
const userName = tg.initDataUnsafe?.user?.first_name || "Гость";

let selectedDate = null;
let selectedSlotId = null;
let selectedServices = [];

// Переключение табов (Исправлено)
document.getElementById("clientBtn").onclick = (e) => { e.stopPropagation(); switchTab('client'); };
document.getElementById("adminBtn").onclick = (e) => { e.stopPropagation(); switchTab('admin'); };

function switchTab(mode) {
  document.getElementById("clientPanel").style.display = mode === 'client' ? 'block' : 'none';
  document.getElementById("adminPanel").style.display = mode === 'admin' ? 'block' : 'none';
  document.getElementById("clientBtn").classList.toggle('active', mode === 'client');
  document.getElementById("adminBtn").classList.toggle('active', mode === 'admin');
  if(mode === 'admin') { loadStats(); fetchAdminData(); }
}

// Календарь
const calendar = document.getElementById("calendar");
const weekdays = ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"];

for (let i = 0; i < 14; i++) {
  const d = new Date(); d.setDate(d.getDate() + i);
  const iso = d.toISOString().split('T')[0];
  const div = document.createElement("div");
  div.className = "day";
  div.innerHTML = `<span>${weekdays[d.getDay()]}</span><b>${d.getDate()}</b>`;
  div.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
    div.classList.add("active");
    selectedDate = iso;
    loadSlots(iso);
  };
  calendar.appendChild(div);
}

// Загрузка слотов
async function loadSlots(date) {
  const container = document.getElementById("slots");
  container.innerHTML = "<div style='grid-column:1/4; padding:20px; text-align:center;'>...</div>";
  try {
    const res = await fetch(`${API}/slots`);
    const data = await res.json();
    const daySlots = data.filter(s => s.date === date);
    container.innerHTML = "";
    if(daySlots.length === 0) {
      container.innerHTML = "<div style='grid-column:1/4; opacity:0.5; padding:20px; text-align:center;'>Нет окошек на эту дату</div>";
      return;
    }
    daySlots.forEach(s => {
      const btn = document.createElement("div");
      btn.className = "slot"; btn.innerText = s.time;
      btn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected");
        selectedSlotId = s.id;
      };
      container.appendChild(btn);
    });
  } catch(e) { container.innerHTML = "Ошибка связи"; }
}

// Загрузка услуг
async function loadServices() {
  const res = await fetch(`${API}/services`);
  const data = await res.json();
  const container = document.getElementById("servicesContainer");
  data.forEach(s => {
    const item = document.createElement("div");
    item.className = "service-item";
    item.innerHTML = `<div><div style="font-weight:700;">${s.name}</div><div style="font-size:12px; opacity:0.6;">${s.price} ₽</div></div><div class="checkbox"></div>`;
    item.onclick = (e) => {
      e.stopPropagation();
      const idx = selectedServices.findIndex(srv => srv.id === s.id);
      if(idx === -1) { selectedServices.push(s); item.classList.add("active"); }
      else { selectedServices.splice(idx, 1); item.classList.remove("active"); }
      document.getElementById("totalDisplay").innerText = selectedServices.reduce((sum, srv) => sum + srv.price, 0);
    };
    container.appendChild(item);
  });
}

// Бронирование (Логика сохранена)
async function submitBooking() {
  if(!selectedSlotId) return tg.showAlert("Пожалуйста, выберите время");
  if(selectedServices.length === 0) return tg.showAlert("Выберите хотя бы одну услугу");

  const total = parseInt(document.getElementById("totalDisplay").innerText);
  tg.MainButton.show();
  tg.MainButton.setText("ПОДТВЕРЖДАЕМ...");

  try {
    const res = await fetch(`${API}/book`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        slotId: selectedSlotId, userId, userName,
        services: selectedServices.map(s => s.name),
        totalPrice: total, comment: document.getElementById("comment").value
      })
    });
    
    if(res.ok) {
        tg.showPopup({ title: "Успех!", message: "Вы записаны. Мастер скоро свяжется с вами.", buttons: [{type: "close"}] }, () => tg.close());
    } else {
        tg.showAlert("Этот слот уже заняли!");
    }
  } catch(e) { tg.showAlert("Ошибка сервера"); }
  finally { tg.MainButton.hide(); }
}

// Админка
async function loadStats() {
    const res = await fetch(`${API}/stats`);
    const data = await res.json();
    document.getElementById("statRevenue").innerText = `${data.revenue} ₽`;
    document.getElementById("statAvg").innerText = `${data.avg} ₽`;
}

async function fetchAdminData() {
  const res = await fetch(`${API}/appointments/${userId}`);
  const data = await res.json();
  const container = document.getElementById("adminAppointments");
  container.innerHTML = data.length ? "" : "<div style='padding:20px; opacity:0.5;'>Записей нет</div>";
  data.reverse().forEach(a => {
    const item = document.createElement("div");
    item.className = "admin-list-item";
    item.innerHTML = `<b>${a.date} в ${a.time}</b><br>${a.user_name} — ${a.total_price} ₽<br><span style="opacity:0.6">${a.services}</span>`;
    container.appendChild(item);
  });
}

async function handleBulkUpload() {
  const text = document.getElementById("bulkInput").value;
  const lines = text.split('\n').filter(l => l.trim());
  const payload = [];
  lines.forEach(line => {
    const match = line.match(/(\d{2}\.\d{2})\s+(.+)/);
    if(match) {
      const times = match[2].split('/');
      const [day, month] = match[1].split('.');
      payload.push(...times.map(t => ({date: `2026-${month}-${day}`, time: t.trim()})));
    }
  });
  const res = await fetch(`${API}/slots/bulk`, {
    method: "POST", headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ slots: payload })
  });
  if(res.ok) { alert("Опубликовано!"); document.getElementById("bulkInput").value = ""; }
}

loadServices();
</script>
</body>
</html>