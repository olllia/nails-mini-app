<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nails & Aesthetic</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --accent: #1a1a1a;
  --secondary: #8e8e93;
  --bg: #fcfcfc;
  --card: #ffffff;
  --soft-nude: #f2f2f7;
  --radius-lg: 24px;
  --radius-sm: 14px;
  --separator: #f0f0f0;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--accent); }
#app { max-width: 420px; margin: 0 auto; padding: 20px; padding-bottom: 50px; }

header { margin-bottom: 30px; }
header h1 { font-size: 26px; font-weight: 700; margin: 0; }
.tabs { display: flex; background: var(--soft-nude); padding: 4px; border-radius: 14px; margin-bottom: 25px; }
.tabs button { flex: 1; border: none; padding: 10px; border-radius: 11px; font-size: 13px; font-weight: 500; cursor: pointer; background: transparent; }
.tabs button.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

.section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--secondary); margin-bottom: 12px; }
.card { background: var(--card); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; border: 1px solid var(--separator); }

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
.calendar::-webkit-scrollbar { display: none; }
.day { min-width: 58px; padding: 14px 0; border-radius: 18px; text-align: center; background: white; border: 1px solid var(--separator); }
.day.active { background: var(--accent); color: white; border-color: var(--accent); }
.day span { display: block; font-size: 10px; text-transform: uppercase; opacity: 0.6; }

/* –°–ª–æ—Ç—ã */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.slot { padding: 14px; border-radius: var(--radius-sm); text-align: center; font-size: 14px; border: 1px solid var(--separator); cursor: pointer; }
.slot.selected { background: var(--accent); color: white; }

/* –£—Å–ª—É–≥–∏ */
.service-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
.service-item.active .checkbox { background: var(--accent); border-color: var(--accent); position: relative; }
.service-item.active .checkbox::after { content: '‚úì'; color: white; position: absolute; left: 4px; top: -1px; font-size: 12px; }
.checkbox { width: 22px; height: 22px; border: 2px solid #e0e0e0; border-radius: 7px; }

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.stat-box { background: var(--soft-nude); padding: 15px; border-radius: 18px; text-align: center; }
.stat-box b { display: block; font-size: 18px; }
.stat-box span { font-size: 10px; color: var(--secondary); text-transform: uppercase; }

.btn-primary { width: 100%; background: var(--accent); color: white; border: none; border-radius: 18px; padding: 18px; font-size: 16px; font-weight: 600; cursor: pointer; }
textarea { width: 100%; border: 1px solid var(--separator); border-radius: var(--radius-sm); padding: 15px; background: #fafafa; font-family: inherit; }
</style>
</head>
<body>

<div id="app">
  <header>
    <h1>Nails Studio</h1>
    <p id="shopStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </header>

  <div class="tabs">
    <button id="clientBtn" class="active">–ó–∞–ø–∏—Å—å</button>
    <button id="adminBtn">–ú–∞—Å—Ç–µ—Ä</button>
  </div>

  <div id="clientPanel">
    <div class="section-title">1. –î–∞—Ç–∞</div>
    <div class="calendar" id="calendar"></div>
    <div class="section-title">2. –í—Ä–µ–º—è</div>
    <div id="slots" class="slots-grid"></div>
    <div class="section-title">3. –£—Å–ª—É–≥–∏</div>
    <div class="card" id="servicesContainer"></div>
    <div style="text-align:center; padding: 20px 0;">
      <span style="color:var(--secondary); font-size:13px;">–°—É–º–º–∞:</span>
      <div style="font-size:32px; font-weight:700;"><span id="totalDisplay">0</span> ‚ÇΩ</div>
    </div>
    <button class="btn-primary" onclick="submitBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å üíñ</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="section-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
    <div class="stats-container">
      <div class="stat-box"><b id="statRevenue">0 ‚ÇΩ</b><span>–í—ã—Ä—É—á–∫–∞</span></div>
      <div class="stat-box"><b id="statAvg">0 ‚ÇΩ</b><span>–°—Ä. —á–µ–∫</span></div>
    </div>
    <div class="section-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–∫–æ—à–∫–∏</div>
    <div class="card" style="background:#1a1a1a">
      <textarea id="bulkInput" rows="5" style="background:transparent; color:#fff; border:none;" placeholder="04.01 11:00/13:00"></textarea>
      <button class="btn-primary" style="margin-top:10px; background:#fff; color:#000;" onclick="handleBulkUpload()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
    <div id="adminAppointments"></div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const API = "–¢–í–û–ô_API_URL"; // –ó–ê–ú–ï–ù–ò–¢–¨ –ü–†–ò –î–ï–ü–õ–û–ï
const ADMIN_ID = 381232429;

let uId = tg.initDataUnsafe?.user?.id || ADMIN_ID;
let uName = tg.initDataUnsafe?.user?.first_name || "–ì–æ—Å—Ç—å";
let selDate, selSlotId, selSrv = [];

document.getElementById("shopStatus").innerText = `–ü—Ä–∏–≤–µ—Ç, ${uName}!`;

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
document.getElementById("clientBtn").onclick = () => { switchTab('client'); };
document.getElementById("adminBtn").onclick = () => { switchTab('admin'); loadStats(); };

function switchTab(m) {
  document.getElementById("clientPanel").style.display = m==='client'?'block':'none';
  document.getElementById("adminPanel").style.display = m==='admin'?'block':'none';
  document.getElementById("clientBtn").classList.toggle('active', m==='client');
  document.getElementById("adminBtn").classList.toggle('active', m==='admin');
  if(m==='admin') fetchAdminData();
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–∞–ª–µ–Ω–¥–∞—Ä—è
const cal = document.getElementById("calendar");
for (let i = 0; i < 14; i++) {
  const d = new Date(); d.setDate(d.getDate() + i);
  const iso = d.toISOString().split('T')[0];
  const div = document.createElement("div");
  div.className = "day";
  div.innerHTML = `<span>${["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"][d.getDay()]}</span><b>${d.getDate()}</b>`;
  div.onclick = () => {
    document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
    div.classList.add("active"); selDate = iso; loadSlots(iso);
  };
  cal.appendChild(div);
}

async function loadSlots(date) {
  const res = await fetch(`${API}/slots`);
  const data = await res.json();
  const div = document.getElementById("slots");
  div.innerHTML = "";
  data.filter(s => s.date === date).forEach(s => {
    const b = document.createElement("div");
    b.className = "slot"; b.innerText = s.time;
    b.onclick = () => {
      document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
      b.classList.add("selected"); selSlotId = s.id;
    };
    div.appendChild(b);
  });
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .ics —Ñ–∞–π–ª–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function downloadIcs(date, time, srv) {
  const [y,m,d] = date.split('-');
  const [hh,mm] = time.split(':');
  const start = `${y}${m}${d}T${hh}${mm}00`;
  const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${start}\nSUMMARY:–ú–∞–Ω–∏–∫—é—Ä —É –ù–∞—Å—Ç–∏ üíÖ\nDESCRIPTION:–£—Å–ª—É–≥–∏: ${srv}\nEND:VEVENT\nEND:VCALENDAR`;
  const blob = new Blob([ics], {type:'text/calendar'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'nails.ics'; a.click();
}

async function submitBooking() {
  if(!selSlotId) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!");
  const total = parseInt(document.getElementById("totalDisplay").innerText);
  
  const res = await fetch(`${API}/book`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({slotId: selSlotId, userId: uId, userName: uName, services: selSrv.map(s=>s.name), totalPrice: total})
  });

  if(res.ok) {
    tg.showPopup({
      title: "–ì–æ—Ç–æ–≤–æ!",
      message: "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞?",
      buttons: [{id:'ics', text:'–î–æ–±–∞–≤–∏—Ç—å'}, {text:'–ù–µ—Ç'}]
    }, (id) => {
      if(id==='ics') downloadIcs(selDate, document.querySelector('.slot.selected').innerText, selSrv.map(s=>s.name).join(', '));
      tg.close();
    });
  }
}

// –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
async function loadStats() {
  const res = await fetch(`${API}/stats`);
  const data = await res.json();
  document.getElementById("statRevenue").innerText = `${data.revenue} ‚ÇΩ`;
  document.getElementById("statAvg").innerText = `${data.avg} ‚ÇΩ`;
}

async function handleBulkUpload() {
  const lines = document.getElementById("bulkInput").value.split('\n').filter(l => l.trim());
  const slots = [];
  lines.forEach(line => {
    const match = line.match(/(\d{2}\.\d{2})\s+(.+)/);
    if(match) {
      const [day, mon] = match[1].split('.');
      match[2].split('/').forEach(t => slots.push({date: `2026-${mon}-${day}`, time: t.trim()}));
    }
  });
  await fetch(`${API}/slots/bulk`, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({slots})});
  alert("–û–∫–æ—à–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!");
}

async function loadServices() {
  const res = await fetch(`${API}/services`);
  const data = await res.json();
  const container = document.getElementById("servicesContainer");
  data.forEach(s => {
    const item = document.createElement("div");
    item.className = "service-item";
    item.innerHTML = `<div><b>${s.name}</b><br><small>${s.price} ‚ÇΩ</small></div><div class="checkbox"></div>`;
    item.onclick = () => {
      const idx = selSrv.findIndex(x => x.id === s.id);
      if(idx === -1) { selSrv.push(s); item.classList.add("active"); }
      else { selSrv.splice(idx,1); item.classList.remove("active"); }
      document.getElementById("totalDisplay").innerText = selSrv.reduce((a,b)=>a+b.price, 0);
    };
    container.appendChild(item);
  });
}

loadServices();
</script>
</body>
</html>