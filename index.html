<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≥–æ—Ç–æ—á–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --pink: #f6c1cc;
      --pink-dark: #e89aaa;
      --bg: #f7f7f7;
      --card: #ffffff;
      --text: #333;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #f6c1cc 0%, #f7f7f7 160px);
      color: var(--text);
    }

    /* –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #app {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    h2 {
      text-align: center;
      margin: 8px 0 20px;
    }

    h3 {
      margin: 0 0 10px;
    }

    .section {
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .admin {
      border: 2px dashed var(--pink);
    }

    .slot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .slot-time {
      font-weight: 500;
      font-size: 14px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .btn-primary {
      background: var(--pink);
    }

    .btn-primary:active {
      background: var(--pink-dark);
    }

    .btn-secondary {
      background: #eee;
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .empty {
      text-align: center;
      color: #777;
      font-size: 14px;
      padding: 10px 0;
    }

    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 14px 0;
    }
  </style>
</head>

<body>

<div id="app">
  <h2>üíÖ –ó–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≥–æ—Ç–æ—á–∫–∏</h2>
  <div id="content"></div>
</div>

<script>
/* ================= DEV MODE ================= */
let DEV_FORCE_ROLE = localStorage.getItem("devRole") || null;
/* ============================================ */

const tg = window.Telegram.WebApp;
tg.expand();

const ADMIN_ID = 381232429;
const user = tg.initDataUnsafe?.user || {
  id: ADMIN_ID,
  first_name: "DEV"
};

const API = "https://nails-backend-5knq.onrender.com";
const content = document.getElementById("content");

const isAdmin =
  DEV_FORCE_ROLE === "admin" ||
  (DEV_FORCE_ROLE === null && user.id === ADMIN_ID);

/* ===== –ö–õ–Æ–ß–ï–í–û–ï: –ö–û–†–†–ï–ö–¢–ù–´–ô –û–¢–°–¢–£–ü –°–í–ï–†–•–£ ===== */
function applyTopOffset() {
  if (!tg.viewportStableHeight) return;
  const header = window.innerHeight - tg.viewportStableHeight;
  document.getElementById("app").style.paddingTop =
    Math.max(header + 8, 16) + "px";
}
applyTopOffset();
tg.onEvent("viewportChanged", applyTopOffset);
/* ============================================ */

/* ---------- DEV SWITCHER ---------- */
if (user.id === ADMIN_ID) {
  const dev = document.createElement("div");
  dev.className = "section card";
  dev.innerHTML = `
    <strong>DEV —Ä–µ–∂–∏–º</strong><br><br>
    <button class="btn-secondary" onclick="setRole('admin')">üë©‚Äçüé® –ê–¥–º–∏–Ω</button>
    <button class="btn-secondary" onclick="setRole('client')">üë§ –ö–ª–∏–µ–Ω—Ç</button>
    <button class="btn-secondary" onclick="setRole(null)">üîÑ –ê–≤—Ç–æ</button>
  `;
  content.appendChild(dev);
}

function setRole(role) {
  if (role === null) localStorage.removeItem("devRole");
  else localStorage.setItem("devRole", role);
  location.reload();
}
/* ---------------------------------- */

/* ---------- ADMIN ---------- */
if (isAdmin) {
  const adminBlock = document.createElement("div");
  adminBlock.className = "section card admin";
  adminBlock.innerHTML = `
    <h3>üë©‚Äçüé® –ê–¥–º–∏–Ω–∫–∞</h3>
    <input type="date" id="date">
    <input type="time" id="time">
    <button class="btn-primary" onclick="addSlot()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–∫–æ—à–∫–æ</button>
    <hr>
    <button class="btn-secondary" onclick="loadAppointments()">üìã –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø–∏—Å–∏</button>
    <div id="appointments"></div>
  `;
  content.appendChild(adminBlock);
}

/* ---------- SLOTS ---------- */
const slotsBlock = document.createElement("div");
slotsBlock.className = "section card";
slotsBlock.innerHTML = `<h3>üìÖ –°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏</h3>`;
content.appendChild(slotsBlock);

loadSlots();

function loadSlots() {
  fetch(`${API}/slots`)
    .then(r => r.json())
    .then(slots => {
      if (slots.length === 0) {
        slotsBlock.innerHTML += `<div class="empty">–°–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
        return;
      }
      slots.forEach(s => {
        const div = document.createElement("div");
        div.className = "slot";
        div.innerHTML = `
          <div class="slot-time">${s.date} ¬∑ ${s.time}</div>
          <button class="btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        `;
        div.querySelector("button").onclick = () => book(s.id);
        slotsBlock.appendChild(div);
      });
    });
}

function book(slotId) {
  fetch(`${API}/book`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      slotId,
      userId: user.id,
      userName: user.first_name
    })
  }).then(() => {
    tg.showPopup({
      title: "–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ üíÖ",
      message: "–ñ–¥—ë–º –≤–∞—Å –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è",
      buttons: [{ type: "close" }]
    });
    setTimeout(() => tg.close(), 1500);
  });
}

function addSlot() {
  fetch(`${API}/slots`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: date.value,
      time: time.value,
      userId: user.id
    })
  }).then(() => {
    tg.showPopup({
      title: "–ì–æ—Ç–æ–≤–æ",
      message: "–û–∫–æ—à–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ",
      buttons: [{ type: "close" }]
    });
  });
}

function loadAppointments() {
  fetch(`${API}/appointments/${user.id}`)
    .then(r => r.json())
    .then(list => {
      const el = document.getElementById("appointments");
      el.innerHTML = "";
      if (list.length === 0) {
        el.innerHTML = `<div class="empty">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
        return;
      }
      list.forEach(a => {
        const div = document.createElement("div");
        div.textContent = `${a.date} ${a.time} ‚Äî ${a.user_name}`;
        el.appendChild(div);
      });
    });
}
</script>

</body>
</html>
