<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nails & Aesthetic</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --accent: #1a1a1a;
  --secondary: #8e8e93;
  --bg: #fcfcfc;
  --card: #ffffff;
  --soft-nude: #f2f2f7;
  --radius-lg: 24px;
  --radius-sm: 14px;
  --separator: #f0f0f0;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
  background-color: var(--bg);
  color: var(--accent);
  -webkit-font-smoothing: antialiased;
}

#app { max-width: 420px; margin: 0 auto; padding: 20px; padding-bottom: 50px; }

header { margin-bottom: 30px; }
header h1 { font-size: 26px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
header p { color: var(--secondary); margin: 4px 0 0; font-size: 14px; }

/* Tabs */
.tabs { display: flex; background: var(--soft-nude); padding: 4px; border-radius: 14px; margin-bottom: 25px; }
.tabs button { 
  flex: 1; border: none; padding: 10px; border-radius: 11px; font-size: 13px; 
  font-weight: 500; cursor: pointer; background: transparent; transition: 0.2s;
}
.tabs button.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

/* Layout Elements */
.section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--secondary); margin-bottom: 12px; padding-left: 2px; }
.card { background: var(--card); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; border: 1px solid var(--separator); }

/* Stats Grid for Admin */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.stat-item { background: var(--soft-nude); padding: 15px; border-radius: 18px; text-align: center; }
.stat-item span { display: block; font-size: 10px; color: var(--secondary); margin-bottom: 4px; text-transform: uppercase; }
.stat-item b { font-size: 18px; font-weight: 700; }

/* Calendar */
.calendar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
.calendar::-webkit-scrollbar { display: none; }
.day { 
  min-width: 58px; padding: 14px 0; border-radius: 18px; text-align: center; 
  background: white; border: 1px solid var(--separator); transition: 0.3s;
}
.day span { display: block; font-size: 10px; color: var(--secondary); margin-bottom: 4px; text-transform: uppercase; }
.day b { font-size: 17px; font-weight: 600; }
.day.active { background: var(--accent); color: white; border-color: var(--accent); }
.day.active span { color: rgba(255,255,255,0.6); }

/* Slots Grid */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.slot { 
  padding: 14px; border-radius: var(--radius-sm); text-align: center; 
  font-size: 14px; font-weight: 500; background: white; border: 1px solid var(--separator); cursor: pointer; transition: 0.2s;
}
.slot.selected { border-color: var(--accent); background: var(--accent); color: white; }

/* Service List */
.service-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
.service-item:last-child { border: none; }
.service-name { font-weight: 500; font-size: 15px; }
.service-price { color: var(--secondary); font-size: 14px; margin-top: 2px; }
.checkbox { width: 22px; height: 22px; border: 2px solid #e0e0e0; border-radius: 7px; transition: 0.2s; position: relative; }
.service-item.active .checkbox { background: var(--accent); border-color: var(--accent); }
.service-item.active .checkbox::after { content: '‚úì'; color: white; position: absolute; top: -1px; left: 4px; font-size: 13px; }

/* Footer Info */
.total-box { margin: 25px 0; text-align: center; border-top: 1px solid var(--separator); padding-top: 20px; }
.total-label { color: var(--secondary); font-size: 13px; margin-bottom: 6px; }
.total-amount { font-size: 32px; font-weight: 700; letter-spacing: -1px; }

/* Main Button */
.btn-primary { 
  width: 100%; background: var(--accent); color: white; border: none; border-radius: 18px; 
  padding: 18px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
}
.btn-primary:active { transform: scale(0.97); }

/* Inputs */
textarea { 
  width: 100%; border: 1px solid var(--separator); border-radius: var(--radius-sm); padding: 15px; 
  font-family: inherit; font-size: 14px; background: #fafafa; resize: none;
}

/* Admin Styles */
.admin-list-item { padding: 15px; border-bottom: 1px solid var(--separator); font-size: 13px; line-height: 1.5; }
.bulk-textarea { font-family: 'Courier New', monospace; font-size: 12px; background: #1a1a1a; color: #a2fca2; border: none; }
</style>
</head>
<body>

<div id="app">
  <header>
    <h1 id="shopName">Nails & Aesthetic</h1>
    <p id="shopStatus">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
  </header>

  <div class="tabs">
    <button id="clientBtn" class="active">–ó–∞–ø–∏—Å—å</button>
    <button id="adminBtn">–ú–∞—Å—Ç–µ—Ä</button>
  </div>

  <div id="clientPanel">
    <div class="section-title">1. –î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</div>
    <div class="calendar" id="calendar"></div>

    <div class="section-title" style="margin-top:20px;">2. –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è</div>
    <div id="slots" class="slots-grid">
      <div style="grid-column:1/4; color:var(--secondary); font-size:14px; padding:20px 0;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</div>
    </div>

    <div class="section-title" style="margin-top:20px;">3. –í—ã–±–æ—Ä —É—Å–ª—É–≥</div>
    <div class="card" id="servicesContainer"></div>

    <div class="section-title">4. –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
    <div class="card" style="padding: 12px;">
      <textarea id="comment" rows="2" placeholder="–î–ª–∏–Ω–∞, –¥–∏–∑–∞–π–Ω, —Å–Ω—è—Ç–∏–µ..."></textarea>
    </div>

    <div class="total-box">
      <div class="total-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
      <div class="total-amount"><span id="totalDisplay">0</span> ‚ÇΩ</div>
    </div>

    <button class="btn-primary" onclick="submitBooking()">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è üíñ</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="section-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–∏–∑–Ω–µ—Å–∞</div>
    <div class="stats-grid">
        <div class="stat-item"><span>–í—ã—Ä—É—á–∫–∞</span><b id="statRevenue">0 ‚ÇΩ</b></div>
        <div class="stat-item"><span>–°—Ä. —á–µ–∫</span><b id="statAvg">0 ‚ÇΩ</b></div>
    </div>

    <div class="section-title">–ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
    <div class="card" style="background: #1a1a1a;">
      <textarea id="bulkInput" class="bulk-textarea" rows="6" placeholder="04.01 11:00/13:00/15:00"></textarea>
      <button class="btn-primary" style="margin-top:15px; background: #ffffff; color: #000;" onclick="handleBulkUpload()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–∫–æ—à–∫–∏</button>
    </div>
    
    <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</div>
    <div class="card" id="adminAppointments" style="padding:0;"></div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

const API = "https://nails-backend-5knq.onrender.com"; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL
const ADMIN_ID = 381232429;

const userId = tg.initDataUnsafe?.user?.id || 381232429;
const userName = tg.initDataUnsafe?.user?.first_name || "–ì–æ—Å—Ç—å";

let selectedDate = null;
let selectedSlotId = null;
let selectedServices = [];

document.getElementById("shopStatus").innerText = `–ü—Ä–∏–≤–µ—Ç, ${userName}!`;

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
document.getElementById("clientBtn").onclick = () => switchTab('client');
document.getElementById("adminBtn").onclick = () => switchTab('admin');

function switchTab(mode) {
  document.getElementById("clientPanel").style.display = mode === 'client' ? 'block' : 'none';
  document.getElementById("adminPanel").style.display = mode === 'admin' ? 'block' : 'none';
  document.getElementById("clientBtn").classList.toggle('active', mode === 'client');
  document.getElementById("adminBtn").classList.toggle('active', mode === 'admin');
  if(mode === 'admin') {
      fetchAdminData();
      loadStats();
  }
}

// ICS –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
function downloadIcs(date, time, services) {
  const [y, m, d] = date.split('-');
  const [hh, mm] = time.split(':');
  const startDate = `${y}${m}${d}T${hh}${mm}00`;
  const icsMsg = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${startDate}\nSUMMARY:–ú–∞–Ω–∏–∫—é—Ä —É –ù–∞—Å—Ç–∏ üíÖ\nDESCRIPTION:–£—Å–ª—É–≥–∏: ${services}\nEND:VEVENT\nEND:VCALENDAR`;
  const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.setAttribute('download', 'appointment.ics');
  link.click();
}

// –ö–∞–ª–µ–Ω–¥–∞—Ä—å
const calendar = document.getElementById("calendar");
const weekdays = ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"];

for (let i = 0; i < 14; i++) {
  const d = new Date(); d.setDate(d.getDate() + i);
  const iso = d.toISOString().split('T')[0];
  const div = document.createElement("div");
  div.className = "day";
  div.innerHTML = `<span>${weekdays[d.getDay()]}</span><b>${d.getDate()}</b>`;
  div.onclick = () => {
    document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
    div.classList.add("active"); selectedDate = iso; loadSlots(iso);
  };
  calendar.appendChild(div);
}

// –°–ª–æ—Ç—ã
async function loadSlots(date) {
  const container = document.getElementById("slots");
  container.innerHTML = "<div style='grid-column:1/4; padding:20px;'>...</div>";
  try {
    const res = await fetch(`${API}/slots`);
    const data = await res.json();
    const daySlots = data.filter(s => s.date === date);
    container.innerHTML = "";
    if(daySlots.length === 0) {
      container.innerHTML = "<div style='grid-column:1/4; color:var(--secondary); padding:20px;'>–ú–µ—Å—Ç –Ω–µ—Ç</div>";
      return;
    }
    daySlots.forEach(s => {
      const btn = document.createElement("div");
      btn.className = "slot"; btn.innerText = s.time;
      btn.onclick = () => {
        document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected"); selectedSlotId = s.id;
      };
      container.appendChild(btn);
    });
  } catch(e) { container.innerHTML = "–û—à–∏–±–∫–∞ API"; }
}

// –£—Å–ª—É–≥–∏
async function loadServices() {
  const res = await fetch(`${API}/services`);
  const data = await res.json();
  const container = document.getElementById("servicesContainer");
  data.forEach(s => {
    const item = document.createElement("div");
    item.className = "service-item";
    item.innerHTML = `<div><div class="service-name">${s.name}</div><div class="service-price">${s.price} ‚ÇΩ</div></div><div class="checkbox"></div>`;
    item.onclick = () => {
      const idx = selectedServices.findIndex(srv => srv.id === s.id);
      if(idx === -1) { selectedServices.push(s); item.classList.add("active"); }
      else { selectedServices.splice(idx, 1); item.classList.remove("active"); }
      document.getElementById("totalDisplay").innerText = selectedServices.reduce((sum, srv) => sum + srv.price, 0);
    };
    container.appendChild(item);
  });
}

// –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
async function submitBooking() {
  if(!selectedSlotId) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!");
  if(selectedServices.length === 0) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É!");

  const total = parseInt(document.getElementById("totalDisplay").innerText);
  tg.MainButton.setText("–û—Ñ–æ—Ä–º–ª—è–µ–º...").show();
  
  try {
    const res = await fetch(`${API}/book`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        slotId: selectedSlotId, userId, userName,
        services: selectedServices.map(s => s.name),
        totalPrice: total, comment: document.getElementById("comment").value
      })
    });
    
    if(res.ok) {
      tg.showPopup({
        title: "–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!",
        message: "–î–æ–±–∞–≤–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞?",
        buttons: [{id: 'ics', type: 'default', text: 'üóì –î–æ–±–∞–≤–∏—Ç—å'}, {type: 'close', text: '–ù–µ—Ç'}]
      }, (btnId) => {
        if(btnId === 'ics') {
          const slotTime = document.querySelector(".slot.selected").innerText;
          downloadIcs(selectedDate, slotTime, selectedServices.map(s => s.name).join(", "));
        }
        tg.close();
      });
    }
  } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞!"); }
  finally { tg.MainButton.hide(); }
}

// –ê–¥–º–∏–Ω–∫–∞: –º–∞—Å—Å-–∑–∞–≥—Ä—É–∑–∫–∞
async function handleBulkUpload() {
  const text = document.getElementById("bulkInput").value;
  const lines = text.split('\n').filter(l => l.trim());
  const payload = [];
  lines.forEach(line => {
    const match = line.match(/(\d{2}\.\d{2})\s+(.+)/);
    if(match) {
      const times = match[2].split('/');
      const [day, month] = match[1].split('.');
      payload.push(...times.map(t => ({date: `${new Date().getFullYear()}-${month}-${day}`, time: t.trim()})));
    }
  });
  const res = await fetch(`${API}/slots/bulk`, {
    method: "POST", headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ slots: payload })
  });
  if(res.ok) { alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!"); document.getElementById("bulkInput").value = ""; }
}

// –ê–¥–º–∏–Ω–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
async function loadStats() {
    const res = await fetch(`${API}/stats`);
    const data = await res.json();
    document.getElementById("statRevenue").innerText = `${data.revenue} ‚ÇΩ`;
    document.getElementById("statAvg").innerText = `${data.avg} ‚ÇΩ`;
}

// –ê–¥–º–∏–Ω–∫–∞: –ò—Å—Ç–æ—Ä–∏—è
async function fetchAdminData() {
  const res = await fetch(`${API}/appointments/${userId}`);
  const data = await res.json();
  const container = document.getElementById("adminAppointments");
  container.innerHTML = data.length ? "" : "<div style='padding:20px;'>–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç</div>";
  data.reverse().forEach(a => {
    const item = document.createElement("div");
    item.className = "admin-list-item";
    item.innerHTML = `<b>${a.date} –≤ ${a.time}</b><br>${a.user_name} ‚Äî ${a.total_price} ‚ÇΩ<br><span style="color:var(--secondary)">${a.services}</span>`;
    container.appendChild(item);
  });
}

loadServices();
</script>
</body>
</html>