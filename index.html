<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≥–æ—Ç–æ—á–∫–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --pink:#f6c1cc;
  --bg:#f5f5f5;
  --card:#fff;
  --radius:16px;
}

* { box-sizing:border-box; }

body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:linear-gradient(180deg,#f6c1cc 0,#f5f5f5 180px);
}

#app { max-width:420px; margin:0 auto; padding:16px; }
h2 { text-align:center; margin:10px 0 10px; }
.card { background:var(--card); border-radius:var(--radius); padding:14px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
.calendar { display:flex; gap:8px; overflow-x:auto; }
.day { min-width:64px; padding:10px; border-radius:12px; text-align:center; background:#eee; font-size:13px; cursor:pointer; }
.day.active { background:var(--pink); font-weight:600; }
.slot { padding:10px; border:1px solid #eee; border-radius:12px; margin:6px 0; cursor:pointer; }
.slot.selected { background:var(--pink); color:#fff; font-weight:600; }
.service { border:1px solid #eee; border-radius:14px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
button { width:100%; border:none; border-radius:12px; padding:12px; background:var(--pink); font-size:15px; cursor:pointer; margin-top:5px; }
textarea { width:100%; border-radius:12px; border:1px solid #ddd; padding:10px; font-size:14px; resize:none; }
.mode-switch { display:flex; gap:10px; margin-bottom:12px; justify-content:center; }
.mode-switch button { width:120px; }

.admin-form { display:flex; flex-direction:column; gap:8px; margin-bottom:15px; }
.admin-form input, .admin-form select { padding:8px; border-radius:10px; border:1px solid #ddd; font-size:14px; }
.admin-form button { padding:10px; border-radius:10px; background:#f6c1cc; border:none; cursor:pointer; font-weight:600; transition:0.2s; }
.admin-form button:hover { background:#f4a7b8; }
#appointmentsAdmin div { background:#fff0f6; padding:8px; border-radius:10px; margin-bottom:6px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
</style>
</head>
<body>
<div id="app">

<h2>üíÖ –ó–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≥–æ—Ç–æ—á–∫–∏</h2>

<div class="mode-switch">
  <button id="clientBtn">üë§ –ö–ª–∏–µ–Ω—Ç</button>
  <button id="adminBtn">üßë‚Äçüé® –ê–¥–º–∏–Ω</button>
</div>

<!-- ================= –ê–¥–º–∏–Ω–∫–∞ ================= -->
<div id="adminPanel" style="display:none;" class="card">
  <h3>üßë‚Äçüé® –ê–¥–º–∏–Ω–∫–∞</h3>
  
  <div class="admin-form">
    <label>–î–∞—Ç–∞ —Å–ª–æ—Ç–∞:</label>
    <input type="date" id="slotDate" min="" max="">
    
    <label>–í—Ä–µ–º—è:</label>
    <select id="slotTime">
      <option value="11:00">11:00</option>
      <option value="13:00">13:00</option>
      <option value="15:00">15:00</option>
      <option value="17:00">17:00</option>
      <option value="20:00">20:00</option>
    </select>
    
    <button onclick="addSlot()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
  </div>

  <h4>üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏</h4>
  <div id="appointmentsAdmin" style="margin-top:10px;"></div>
</div>

<!-- ================= –ö–ª–∏–µ–Ω—Ç ================= -->
<div id="clientPanel">
  <div class="card">
    <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</h3>
    <div class="calendar" id="calendar"></div>
  </div>

  <div class="card">
    <h3>‚è∞ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã</h3>
    <div id="slots"></div>
  </div>

  <div class="card">
    <h3>üí∏ –£—Å–ª—É–≥–∏</h3>
    <div id="services"></div>
    <div style="margin-top:10px; font-weight:600;">–ò—Ç–æ–≥–æ: <span id="total">0</span>‚ÇΩ</div>
  </div>

  <div class="card">
    <h3>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
    <textarea id="comment" rows="3" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, –¥–∏–∑–∞–π–Ω, –¥–ª–∏–Ω–∞..."></textarea>
  </div>

  <button onclick="submitBooking()">üíñ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
</div>

<script>
const API = "https://nails-backend-5knq.onrender.com";
let selectedDate = null;
let selectedSlotId = null;
let selectedServices = [];
let totalPrice = 0;

// –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–¥–º–∏–Ω–∫–∏
let userId = 381232429;
let userName = "–ò—Ä–∏–Ω–∞";

// –≠–ª–µ–º–µ–Ω—Ç—ã
const calendar = document.getElementById("calendar");
const slotsDiv = document.getElementById("slots");
const servicesDiv = document.getElementById("services");
const totalSpan = document.getElementById("total");
const commentInput = document.getElementById("comment");
const clientPanel = document.getElementById("clientPanel");
const adminPanel = document.getElementById("adminPanel");
const appointmentsAdmin = document.getElementById("appointmentsAdmin");

// --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ ---
document.getElementById("clientBtn").onclick = ()=>{ clientPanel.style.display="block"; adminPanel.style.display="none"; };
document.getElementById("adminBtn").onclick = ()=>{ clientPanel.style.display="none"; adminPanel.style.display="block"; fetchAppointments(); };

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ min/max –¥–∞—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ ---
const today = new Date();
const minDate = today.toISOString().split("T")[0];
const maxDateObj = new Date(); maxDateObj.setDate(today.getDate()+13);
const maxDate = maxDateObj.toISOString().split("T")[0];
document.getElementById("slotDate").setAttribute("min", minDate);
document.getElementById("slotDate").setAttribute("max", maxDate);
document.getElementById("slotDate").value = minDate;

// --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 14 –¥–Ω–µ–π ---
for(let i=0;i<14;i++){
  const d = new Date();
  d.setDate(d.getDate()+i);
  const div=document.createElement("div");
  div.className="day";
  div.innerHTML=`${d.getDate()}<br>${["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"][d.getDay()]}`;
  div.onclick=()=>selectDate(d);
  calendar.appendChild(div);
}

// --- –í—ã–±–æ—Ä –¥–∞—Ç—ã ---
function selectDate(d){
  selectedDate = d.toISOString().split("T")[0];
  document.querySelectorAll(".day").forEach(x=>x.classList.remove("active"));
  event.currentTarget.classList.add("active");
  fetchSlots();
}

// --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ ---
async function fetchSlots(){
  slotsDiv.innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
  const res = await fetch(`${API}/slots`);
  const data = await res.json();
  slotsDiv.innerHTML="";
  const daySlots = data.filter(s => s.date===selectedDate);
  if(daySlots.length===0){ slotsDiv.innerHTML="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤"; return; }

  daySlots.forEach(s=>{
    const div=document.createElement("div");
    div.className="slot";
    div.innerText=s.time;
    div.onclick=()=>selectSlot(s.id, div);
    slotsDiv.appendChild(div);
  });
}

// --- –í—ã–±–æ—Ä —Å–ª–æ—Ç–∞ ---
function selectSlot(id, div){
  selectedSlotId = id;
  document.querySelectorAll(".slot").forEach(x=>x.classList.remove("selected"));
  div.classList.add("selected");
}

// --- –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Å–ª—É–≥ ---
async function fetchServices(){
  const res = await fetch(`${API}/services`);
  const data = await res.json();
  servicesDiv.innerHTML="";
  data.forEach(s=>{
    const div=document.createElement("div");
    div.className="service";
    div.innerHTML=`<span>${s.name} ‚Äî ${s.price}‚ÇΩ</span>`;
    const btn = document.createElement("button");
    btn.innerText="–í—ã–±—Ä–∞—Ç—å";
    btn.onclick=()=>toggleService(s, btn);
    div.appendChild(btn);
    servicesDiv.appendChild(div);
  });
}

// --- –í—ã–±–æ—Ä —É—Å–ª—É–≥ ---
function toggleService(service, btn){
  const index = selectedServices.findIndex(s=>s.id===service.id);
  if(index===-1){ selectedServices.push(service); btn.innerText="–°–Ω—è—Ç–æ"; }
  else { selectedServices.splice(index,1); btn.innerText="–í—ã–±—Ä–∞—Ç—å"; }
  totalPrice = selectedServices.reduce((a,b)=>a+b.price,0);
  totalSpan.innerText = totalPrice;
}

// --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ---
async function submitBooking(){
  if(!selectedDate || !selectedSlotId){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ —Å–ª–æ—Ç"); return; }
  if(selectedServices.length===0){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É"); return; }

  const payload = {
    slotId: selectedSlotId,
    userId,
    userName,
    services: selectedServices.map(s=>s.name),
    totalPrice,
    comment: commentInput.value
  };

  const res = await fetch(`${API}/book`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if(data.success){
    Telegram.WebApp.showPopup({title:"–ì–æ—Ç–æ–≤–æ üíÖ", message:"–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å", buttons:[{type:"close"}]});
    fetchSlots();
  }else{
    alert(data.error || "–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è");
  }
}

// --- –ê–¥–º–∏–Ω–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç –≤—Ä—É—á–Ω—É—é ---
async function addSlot(){
  const date = document.getElementById("slotDate").value;
  const time = document.getElementById("slotTime").value;
  if(!date || !time){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"); return; }

  try{
    const res = await fetch(`${API}/slots`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({date, time, userId})
    });
    if(res.ok){ alert("–°–ª–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!"); fetchAppointments(); }
    else { const err = await res.json(); alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞: "+(err.error||res.statusText)); }
  } catch(e){ alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞: "+e.message); }
}

// --- –ê–¥–º–∏–Ω–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø–∏—Å–∏ ---
async function fetchAppointments(){
  const res = await fetch(`${API}/appointments/${userId}`);
  const data = await res.json();
  appointmentsAdmin.innerHTML="";
  data.forEach(a=>{
    const div = document.createElement("div");
    div.innerHTML=`${a.date} ${a.time} ‚Äî ${a.user_name} ‚Äî ${a.services} ‚Äî ${a.total_price}‚ÇΩ ‚Äî ${a.status}`;
    appointmentsAdmin.appendChild(div);
  });
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
fetchServices();
</script>
</body>
</html>
