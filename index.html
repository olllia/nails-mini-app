<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nails Studio</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --pink: #F8C8DC;
  --dark-pink: #F4A7B8;
  --bg: #FDFBFB;
  --text: #4A4A4A;
  --card: #FFFFFF;
  --radius: 20px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  line-height: 1.4;
}

#app { max-width: 420px; margin: 0 auto; padding: 16px; padding-bottom: 40px; }

h2 { text-align: center; font-weight: 300; letter-spacing: 1px; color: #333; }
h3 { font-size: 17px; margin-bottom: 12px; font-weight: 600; }

.card { 
  background: var(--card); 
  border-radius: var(--radius); 
  padding: 18px; 
  margin-bottom: 16px; 
  box-shadow: 0 4px 15px rgba(244, 167, 184, 0.1);
  border: 1px solid rgba(248, 200, 220, 0.3);
}

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
.calendar::-webkit-scrollbar { display: none; }
.day { 
  min-width: 60px; padding: 12px 8px; border-radius: 15px; 
  text-align: center; background: #F9F9F9; transition: 0.3s; cursor: pointer; border: 1px solid #EEE;
}
.day.active { background: var(--pink); border-color: var(--dark-pink); transform: scale(1.05); }
.day b { display: block; font-size: 18px; }

/* –°–ª–æ—Ç—ã */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.slot { 
  padding: 12px; border: 1px solid #EEE; border-radius: 12px; 
  text-align: center; font-size: 14px; cursor: pointer; transition: 0.2s;
}
.slot.selected { background: var(--pink); border-color: var(--dark-pink); font-weight: 600; }

/* –£—Å–ª—É–≥–∏ */
.service { 
  display: flex; justify-content: space-between; align-items: center; 
  padding: 12px 0; border-bottom: 1px solid #F5F5F5;
}
.service:last-child { border: none; }
.service-info h4 { margin: 0; font-size: 15px; }
.service-info span { font-size: 13px; color: #888; }
.service-price { font-weight: 700; margin-right: 10px; white-space: nowrap; }
.select-btn { 
  background: #F0F0F0; border: none; border-radius: 10px; 
  padding: 6px 12px; font-size: 12px; cursor: pointer; min-width: 85px;
}
.select-btn.active { background: var(--dark-pink); color: white; }

/* –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã */
.main-btn { 
  width: 100%; background: var(--dark-pink); color: white; border: none; 
  border-radius: 15px; padding: 16px; font-size: 16px; font-weight: 600;
  cursor: pointer; box-shadow: 0 4px 10px rgba(244, 167, 184, 0.3);
}
textarea { 
  width: 100%; border-radius: 12px; border: 1px solid #EEE; padding: 12px; 
  font-size: 14px; background: #FAFAFA;
}

.mode-switch { display: flex; gap: 8px; margin-bottom: 20px; }
.mode-switch button { 
  flex: 1; padding: 10px; border-radius: 12px; border: none; background: #EEE; font-size: 13px;
}
.mode-switch button.active { background: var(--pink); font-weight: 600; }

/* –ê–¥–º–∏–Ω–∫–∞ –∑–∞–ø–∏—Å–∏ */
.appointment-item { 
  font-size: 13px; padding: 10px; border-bottom: 1px solid #F5F5F5; 
}
</style>
</head>
<body>

<div id="app">
  <h2>Nails Studio üíÖ</h2>

  <div class="mode-switch">
    <button id="clientBtn" class="active">–ö–ª–∏–µ–Ω—Ç</button>
    <button id="adminBtn">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏</button>
  </div>

  <div id="clientPanel">
    <div class="card">
      <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</h3>
      <div class="calendar" id="calendar"></div>
    </div>

    <div class="card">
      <h3>‚è∞ –°–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è</h3>
      <div id="slots" class="slots-grid">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</div>
    </div>

    <div class="card">
      <h3>‚ú® –£—Å–ª—É–≥–∏</h3>
      <div id="services"></div>
      <div style="margin-top:15px; text-align: right;">
        <span style="color: #888;">–ò—Ç–æ–≥–æ:</span> 
        <b style="font-size: 20px;"><span id="total">0</span>‚ÇΩ</b>
      </div>
    </div>

    <div class="card">
      <h3>üìù –ü–æ–∂–µ–ª–∞–Ω–∏—è</h3>
      <textarea id="comment" rows="2" placeholder="–î–∏–∑–∞–π–Ω, –¥–ª–∏–Ω–∞, —Å–Ω—è—Ç–∏–µ..."></textarea>
    </div>

    <button class="main-btn" onclick="submitBooking()">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è üíñ</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="card">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</h3>
      <input type="date" id="slotDate" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #EEE;">
      <select id="slotTime" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #EEE;">
        <option value="10:00">10:00</option>
        <option value="12:00">12:00</option>
        <option value="14:00">14:00</option>
        <option value="16:00">16:00</option>
        <option value="18:00">18:00</option>
        <option value="20:00">20:00</option>
      </select>
      <button class="main-btn" onclick="addSlot()">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
    </div>

    <div class="card" style="background: #fdf2f5;">
      <h3>üöÄ –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–¥–ª—è –ù–∞—Å—Ç–∏)</h3>
      <p style="font-size: 11px; color: #888;">–í—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ –≤–∏–¥–∞: 04.01 11:00/13:00/15:00</p>
      <textarea id="bulkInput" rows="5" placeholder="04.01 11:00/13:00/15:00
    05.01 11:00/13:00"></textarea>
      <button class="main-btn" style="margin-top:10px; background: #6c5ce7;" onclick="processBulk()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Å—å –º–µ—Å—è—Ü ‚ú®</button>
    </div>

    <div class="card">
      <h3>üìã –í—Å–µ –∑–∞–ø–∏—Å–∏</h3>
      <div id="appointmentsAdmin"></div>
    </div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API = "https://nails-backend-5knq.onrender.com"; // –ü—Ä–æ–≤–µ—Ä—å URL!
const ADMIN_ID = 381232429;

let userId = tg.initDataUnsafe?.user?.id || 381232429;
let userName = tg.initDataUnsafe?.user?.first_name || "–ö–ª–∏–µ–Ω—Ç";

let selectedDate = null;
let selectedSlotId = null;
let selectedServices = [];

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
document.getElementById("clientBtn").onclick = function() {
  this.classList.add("active");
  document.getElementById("adminBtn").classList.remove("active");
  document.getElementById("clientPanel").style.display = "block";
  document.getElementById("adminPanel").style.display = "none";
};

document.getElementById("adminBtn").onclick = function() {
  this.classList.add("active");
  document.getElementById("clientBtn").classList.remove("active");
  document.getElementById("clientPanel").style.display = "none";
  document.getElementById("adminPanel").style.display = "block";
  fetchAppointments();
};

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const calendarEl = document.getElementById("calendar");
const days = ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"];

for (let i = 0; i < 14; i++) {
  const d = new Date();
  d.setDate(d.getDate() + i);
  const dateStr = d.toISOString().split("T")[0];
  
  const div = document.createElement("div");
  div.className = "day";
  div.innerHTML = `<span>${days[d.getDay()]}</span><b>${d.getDate()}</b>`;
  div.onclick = (e) => {
    document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
    div.classList.add("active");
    selectedDate = dateStr;
    fetchSlots(dateStr);
  };
  calendarEl.appendChild(div);
}

async function fetchSlots(date) {
  const slotsDiv = document.getElementById("slots");
  slotsDiv.innerHTML = "‚åõ...";
  
  try {
    const res = await fetch(`${API}/slots`);
    const allSlots = await res.json();
    const daySlots = allSlots.filter(s => s.date === date);
    
    slotsDiv.innerHTML = "";
    if (daySlots.length === 0) {
      slotsDiv.innerHTML = "<div style='grid-column: 1/4; color: #999;'>–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç</div>";
      return;
    }
    
    daySlots.forEach(s => {
      const d = document.createElement("div");
      d.className = "slot";
      d.innerText = s.time;
      d.onclick = () => {
        document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
        d.classList.add("selected");
        selectedSlotId = s.id;
      };
      slotsDiv.appendChild(d);
    });
  } catch (e) {
    slotsDiv.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
  }
}

async function fetchServices() {
  const res = await fetch(`${API}/services`);
  const data = await res.json();
  const container = document.getElementById("services");
  container.innerHTML = "";

  data.forEach(s => {
    const div = document.createElement("div");
    div.className = "service";
    div.innerHTML = `
      <div class="service-info">
        <h4>${s.name}</h4>
        <span>${s.desc}</span>
      </div>
      <div style="display:flex; align-items:center;">
        <span class="service-price">${s.price}‚ÇΩ</span>
        <button class="select-btn" id="srv-${s.id}">–í—ã–±—Ä–∞—Ç—å</button>
      </div>
    `;
    div.querySelector("button").onclick = (e) => toggleService(s, e.target);
    container.appendChild(div);
  });
}

function toggleService(service, btn) {
  const idx = selectedServices.findIndex(s => s.id === service.id);
  if (idx === -1) {
    selectedServices.push(service);
    btn.innerText = "–í—ã–±—Ä–∞–Ω–æ ‚úÖ";
    btn.classList.add("active");
  } else {
    selectedServices.splice(idx, 1);
    btn.innerText = "–í—ã–±—Ä–∞—Ç—å";
    btn.classList.remove("active");
  }
  const total = selectedServices.reduce((sum, s) => sum + s.price, 0);
  document.getElementById("total").innerText = total;
}

async function submitBooking() {
  if (!selectedSlotId) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏!");
  if (selectedServices.length === 0) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É!");

  const payload = {
    slotId: selectedSlotId,
    userId: userId,
    userName: userName,
    services: selectedServices.map(s => s.name),
    totalPrice: parseInt(document.getElementById("total").innerText),
    comment: document.getElementById("comment").value
  };

  tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∫–∞...").show();

  try {
    const res = await fetch(`${API}/book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    
    if (result.success) {
      tg.showPopup({
        title: "–£—Å–ø–µ—à–Ω–æ!",
        message: "–ù–∞—Å—Ç—è —É–∂–µ –ø–æ–ª—É—á–∏–ª–∞ —Ç–≤–æ—é –∑–∞—è–≤–∫—É. –î–æ –≤—Å—Ç—Ä–µ—á–∏!",
        buttons: [{ type: "close" }]
      }, () => tg.close());
    } else {
      tg.showAlert("–û—à–∏–±–∫–∞: " + result.error);
    }
  } catch (e) {
    tg.showAlert("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç");
  } finally {
    tg.MainButton.hide();
  }
}

// –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
async function addSlot() {
  const date = document.getElementById("slotDate").value;
  const time = document.getElementById("slotTime").value;
  await fetch(`${API}/slots`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date, time })
  });
  alert("–°–ª–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
}

async function fetchAppointments() {
  const res = await fetch(`${API}/appointments/${userId}`);
  const data = await res.json();
  const container = document.getElementById("appointmentsAdmin");
  container.innerHTML = data.map(a => `
    <div class="appointment-item">
      <b>${a.date} –≤ ${a.time}</b><br>
      üë§ ${a.user_name} | üí∞ ${a.total_price}‚ÇΩ<br>
      üíÖ ${a.services}
    </div>
  `).join("");
}

async function processBulk() {
  const text = document.getElementById("bulkInput").value;
  const lines = text.split('\n').filter(l => l.trim() !== '');
  const slotsToUpload = [];

  lines.forEach(line => {
    // –†–µ–≥—É–ª—è—Ä–∫–∞ –≤—ã—Ü–µ–ø–ª—è–µ—Ç –¥–∞—Ç—É –∏ –≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ –Ω–µ—ë
    const match = line.match(/(\d{2}\.\d{2})\s+(.+)/);
    if (match) {
      const dayMonth = match[1]; // "04.01"
      const times = match[2].split('/'); // ["11:00", "13:00"]
      
      // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º "04.01" –≤ "2026-01-04"
      const [day, month] = dayMonth.split('.');
      const year = new Date().getFullYear();
      const dateIso = `${year}-${month}-${day}`;

      times.forEach(t => {
        slotsToUpload.push({ date: dateIso, time: t.trim() });
      });
    }
  });

  if (slotsToUpload.length === 0) return alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç");

  const res = await fetch(`${API}/slots/bulk`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ slots: slotsToUpload })
  });
  
  if (res.ok) {
    alert(`–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${slotsToUpload.length} —Å–ª–æ—Ç–æ–≤!`);
    document.getElementById("bulkInput").value = "";
  }
}

fetchServices();
</script>
</body>
</html>